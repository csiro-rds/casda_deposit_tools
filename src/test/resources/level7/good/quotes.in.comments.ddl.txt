-- Table creation script for Atlas Sources for ''Project Foo''
-- Generated by CASDA Data Deposit on 2015-04-07

UPDATE casda.catalogue SET level7_active='f' where level7_collection_id IN 
(SELECT id FROM casda.level7_collection WHERE dc_common_id = 255);

UPDATE casda.catalogue SET entries_table_name = 'casda.quotesincomments_v01', version = (version+1), level7_active='t', deposit_state='PROCESSED'
WHERE level7_collection_id = (SELECT id FROM casda.level7_collection WHERE dap_collection_id = 123456)
  AND filename = 'quotes.in.comments.xml';

CREATE table casda.quotesincomments_v01 (
    id BIGSERIAL PRIMARY KEY,
    catalogue_id BIGINT NOT NULL,
    component_name VARCHAR(26),
    ra_deg_cont DOUBLE PRECISION,
    dec_deg_cont DOUBLE PRECISION
);

CREATE INDEX ON casda.quotesincomments_v01(catalogue_id); 
CREATE INDEX ON casda.quotesincomments_v01(component_name); 
CREATE INDEX ON casda.quotesincomments_v01(ra_deg_cont); 
CREATE INDEX ON casda.quotesincomments_v01(dec_deg_cont); 

COMMENT ON TABLE casda.quotesincomments_v01 is 'Atlas Sources for ''Project Foo''';
COMMENT ON COLUMN casda.quotesincomments_v01.id is 'Primary key'; 
COMMENT ON COLUMN casda.quotesincomments_v01.catalogue_id is 'Foreign key to the catalogue table'; 
COMMENT ON COLUMN casda.quotesincomments_v01.ra_deg_cont is 'J2000 ''right ascension'' in decimal degrees'; 
COMMENT ON COLUMN casda.quotesincomments_v01.dec_deg_cont is 'J2000 declination in decimal degrees'; 

-- TAP metadata creation script for Atlas Sources for 'Project Foo'
-- Generated by CASDA Data Deposit on 2015-04-07

UPDATE casda.tap_tables
SET params = regexp_replace(params, 'Latest version : v[0-9]+', 'Latest version : v1')
WHERE 'casda.'||db_table_name in
(SELECT entries_table_name 
FROM casda.catalogue c 
INNER JOIN casda.level7_collection lc on c.level7_collection_id = lc.id 
WHERE lc.dc_common_id = 255 
  AND entries_table_name similar to 'casda.quotesincomments_v(0|1|2|3|4|5|6|7|8|9)+');


INSERT INTO casda.tap_schemas (schema_name, description)
    SELECT 'C009', 'Derived catalogues for project C009'
    WHERE NOT EXISTS (
    (SELECT * from casda.tap_schemas WHERE schema_name = 'C009'));

INSERT INTO casda.tap_tables (schema_name, table_name, table_type, db_schema_name, db_table_name, description, scs_enabled, params )
VALUES ('C009', 'C009.quotesincomments_v01', 'table', 'casda', 'quotesincomments_v01', 'Atlas Sources for 'Project Foo'', true,
'Catalogue Name : quotesincomments | Principal Fields : component_name,ra_deg_cont, dec_deg_cont | Indexed Fields : component_name,ra_deg_cont,dec_deg_cont | This version : v1 | Latest version : v1');

INSERT INTO casda.tap_columns (column_order, db_column_name, table_name, datatype, size, principal, indexed, std, description, column_name,  ucd, unit, scs_verbosity )
VALUES 
(1, 'id', 'C009.quotesincomments_v01', 'BIGINT', 19, 1, 1, 1, 'Primary key', 'id', 'meta.record', null, 1),
(2, 'catalogue_id', 'C009.quotesincomments_v01', 'BIGINT', 19, 1, 1, 1, 'Catalogue identifier', 'catalogue_id', null, null, 3),
(3, 'component_name', 'C009.quotesincomments_v01', 'VARCHAR', 26, 1, 1, 1, '', 'component_name', 'meta.id;meta.main', null, 1),
(4, 'ra_deg_cont', 'C009.quotesincomments_v01', 'DOUBLE', 19, 1, 1, 1, 'J2000 ''right ascension'' in decimal degrees', 'ra_deg_cont', 'pos.eq.ra;meta.main', 'deg', 1),
(5, 'dec_deg_cont', 'C009.quotesincomments_v01', 'DOUBLE', 19, 1, 1, 1, 'J2000 declination in decimal degrees', 'dec_deg_cont', 'pos.eq.dec;meta.main', 'deg', 1)
;

INSERT INTO casda.tap_keys (key_id, from_table, target_table, description )
VALUES ((SELECT max(cast(numericalkeys.nums[1] as int)) + 1 from (SELECT regexp_matches(key_id, '^\d+$') as nums from casda.tap_keys) as numericalkeys), 'C009.quotesincomments_v01', 'casda.catalogue', 'Foreign key from quotesincomments_v01 to catalogue table');

INSERT INTO casda.tap_key_columns (id, key_id, from_column, target_column, from_table, target_table )
VALUES ((SELECT max(id) + 1 from casda.tap_key_columns), (SELECT key_id FROM casda.tap_keys where from_table = 'C009.quotesincomments_v01' and target_table = 'casda.catalogue'), 'catalogue_id', 'id', 'C009.quotesincomments_v01', 'casda.catalogue');

INSERT INTO casda.quotesincomments_v01 (catalogue_id, component_name, ra_deg_cont, dec_deg_cont)
VALUES ((SELECT id from casda.catalogue where catalogue_type = 'DERIVED_CATALOGUE' and entries_table_name = 'casda.quotesincomments_v01'), '00001', 320, 55.55);

INSERT INTO casda.quotesincomments_v01 (catalogue_id, component_name, ra_deg_cont, dec_deg_cont)
VALUES ((SELECT id from casda.catalogue where catalogue_type = 'DERIVED_CATALOGUE' and entries_table_name = 'casda.quotesincomments_v01'), '00002', 320, 55.55);
